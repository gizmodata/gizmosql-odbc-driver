name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    name: Build Linux (${{ matrix.arch }})
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libboost-all-dev \
            unixodbc-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            libprotoc-dev \
            protobuf-compiler \
            protobuf-compiler-grpc \
            libssl-dev \
            rapidjson-dev

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: libgizmosql-odbc-linux-${{ matrix.arch }}.so
          path: build/*/lib/libgizmosql-odbc.so
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    name: Build macOS (arm64)
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake boost libiodbc grpc protobuf openssl@3 rapidjson

      - name: Configure
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: libgizmosql-odbc-macos-arm64.dylib
          path: build/*/lib/libgizmosql-odbc.dylib
          if-no-files-found: error

  build-windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            triplet: x64-windows
            cmake_arch: x64
          - arch: arm64
            triplet: arm64-windows
            cmake_arch: ARM64
    runs-on: windows-latest
    name: Build Windows (${{ matrix.arch }})
    steps:
      - uses: actions/checkout@v4

      - name: Set up vcpkg
        run: |
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV

      - name: Install dependencies
        run: |
          & "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe" install --triplet ${{ matrix.triplet }} --x-install-root="$env:VCPKG_INSTALLATION_ROOT\installed"

      - name: Configure
        run: |
          cmake -B build `
            -DARROW_GIT_REPOSITORY=https://github.com/apache/arrow.git `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=${{ matrix.triplet }} `
            -DVCPKG_MANIFEST_MODE=OFF `
            -G "Visual Studio 17 2022" `
            -A ${{ matrix.cmake_arch }} `
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel 8 --config Release

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: gizmosql-odbc-windows-${{ matrix.arch }}.dll
          path: build/Release/**/gizmosql-odbc.dll
          if-no-files-found: error

  integration-test-linux:
    needs: build-linux
    name: Integration Tests (Linux x64)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    services:
      gizmosql:
        image: gizmodata/gizmosql:latest
        ports:
          - 31337:31337
        env:
          GIZMOSQL_USERNAME: gizmosql_user
          GIZMOSQL_PASSWORD: gizmosql_password
          DATABASE_FILENAME: /tmp/test.duckdb
          TLS_ENABLED: "0"
          PRINT_QUERIES: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Install ODBC runtime and driver dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc libgrpc++-dev libprotobuf-dev libssl-dev

      - name: Download driver artifact
        uses: actions/download-artifact@v4
        with:
          name: libgizmosql-odbc-linux-x64.so
          path: driver

      - name: Find and install driver
        run: |
          DRIVER_PATH=$(find driver -name '*.so' -print -quit)
          cp "$DRIVER_PATH" /tmp/libgizmosql-odbc.so
          chmod +x /tmp/libgizmosql-odbc.so
          echo "DRIVER_PATH=/tmp/libgizmosql-odbc.so" >> $GITHUB_ENV

      - name: Verify exported symbols
        run: |
          echo "=== Exported SQL symbols ==="
          nm -D "$DRIVER_PATH" | grep ' T SQL' | head -20
          echo "..."
          nm -D "$DRIVER_PATH" | grep -c ' T SQL'
          echo "SQL* symbols exported"

      - name: Wait for GizmoSQL
        run: |
          for i in $(seq 1 30); do
            nc -z localhost 31337 && echo "GizmoSQL is ready" && exit 0
            echo "Waiting for GizmoSQL... ($i/30)"
            sleep 2
          done
          echo "GizmoSQL did not start in time" && exit 1

      - name: Register driver in odbcinst.ini
        run: |
          cat > /tmp/odbcinst.ini << 'EOF'
          [GizmoSQL ODBC Driver]
          Description = GizmoSQL ODBC Driver
          Driver      = /tmp/libgizmosql-odbc.so
          EOF

          cat > /tmp/odbc.ini << 'EOF'
          [GizmoSQL Test]
          Driver        = GizmoSQL ODBC Driver
          host          = localhost
          port          = 31337
          uid           = gizmosql_user
          pwd           = gizmosql_password
          useEncryption = false
          EOF

          echo "ODBCSYSINI=/tmp" >> $GITHUB_ENV
          echo "ODBCINI=/tmp/odbc.ini" >> $GITHUB_ENV

      - name: Debug driver and ODBC configuration
        run: |
          echo "=== Driver shared library dependencies ==="
          ldd /tmp/libgizmosql-odbc.so || true

          echo ""
          echo "=== ODBC configuration ==="
          odbcinst -j 2>/dev/null || echo "(odbcinst not available)"

          echo ""
          echo "=== Contents of /tmp/odbcinst.ini ==="
          cat -A /tmp/odbcinst.ini

          echo ""
          echo "=== Contents of /tmp/odbc.ini ==="
          cat -A /tmp/odbc.ini

          echo ""
          echo "=== Test dlopen/dlsym directly (bypass DM) ==="
          python3 << 'PYEOF'
          import ctypes, sys

          try:
              lib = ctypes.CDLL('/tmp/libgizmosql-odbc.so')
              print('Driver loaded successfully')

              SQL_HANDLE_ENV = 1
              SQL_HANDLE_DBC = 2
              SQL_NULL_HANDLE = ctypes.c_void_p(0)
              SQL_ATTR_ODBC_VERSION = 200
              SQL_OV_ODBC3 = ctypes.c_void_p(3)

              # Test ENV allocation
              henv = ctypes.c_void_p()
              rc = lib.SQLAllocHandle(SQL_HANDLE_ENV, SQL_NULL_HANDLE, ctypes.byref(henv))
              print(f'SQLAllocHandle(ENV) returned: {rc}, henv={henv.value}')

              if rc != 0:
                  print('ENV allocation failed!')
                  sys.exit(1)

              # Set ODBC version
              rc = lib.SQLSetEnvAttr(henv, SQL_ATTR_ODBC_VERSION, SQL_OV_ODBC3, 0)
              print(f'SQLSetEnvAttr(ODBC_VERSION=3) returned: {rc}')

              # Test DBC allocation
              hdbc = ctypes.c_void_p()
              rc = lib.SQLAllocHandle(SQL_HANDLE_DBC, henv, ctypes.byref(hdbc))
              print(f'SQLAllocHandle(DBC) returned: {rc}, hdbc={hdbc.value}')

              if rc != 0:
                  # Get diagnostics from ENV handle
                  buf = ctypes.create_string_buffer(1024)
                  state = ctypes.create_string_buffer(6)
                  native_err = ctypes.c_int()
                  msg_len = ctypes.c_short()
                  drc = lib.SQLGetDiagRec(1, henv, 1, state, ctypes.byref(native_err), buf, 1024, ctypes.byref(msg_len))
                  print(f'ENV diag rc={drc}, state={state.value}, msg={buf.value[:msg_len.value]}')
                  print('DBC allocation failed!')
                  sys.exit(1)

              # Test SQLDriverConnect
              conn_str = b'host=localhost;port=31337;uid=gizmosql_user;pwd=gizmosql_password;useEncryption=false'
              out_str = ctypes.create_string_buffer(1024)
              out_len = ctypes.c_short()
              rc = lib.SQLDriverConnect(hdbc, None, conn_str, len(conn_str), out_str, 1024, ctypes.byref(out_len), 0)
              print(f'SQLDriverConnect returned: {rc}')

              if rc != 0:
                  buf = ctypes.create_string_buffer(1024)
                  state = ctypes.create_string_buffer(6)
                  native_err = ctypes.c_int()
                  msg_len = ctypes.c_short()
                  drc = lib.SQLGetDiagRec(2, hdbc, 1, state, ctypes.byref(native_err), buf, 1024, ctypes.byref(msg_len))
                  print(f'DBC diag rc={drc}, state={state.value}, msg={buf.value[:msg_len.value]}')
              else:
                  print('Connection successful!')

              # Clean up
              lib.SQLDisconnect(hdbc)
              lib.SQLFreeHandle(SQL_HANDLE_DBC, hdbc)
              lib.SQLFreeHandle(SQL_HANDLE_ENV, henv)
              print('All direct driver tests passed!')

          except Exception as e:
              print(f'Error: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          PYEOF

      - name: Run integration tests with isql
        run: |
          CONN="Driver=/tmp/libgizmosql-odbc.so;host=localhost;port=31337;uid=gizmosql_user;pwd=gizmosql_password;useEncryption=false"

          echo "=== Test 1: Basic SELECT via DSN ==="
          echo "SELECT 1 AS test_value;" | isql -v "GizmoSQL Test" 2>&1

          echo "=== Test 2: Basic SELECT via connection string ==="
          echo "SELECT 42 AS answer;" | isql -v -k "$CONN" 2>&1

          echo "=== Test 3: DDL - CREATE TABLE (lazy fetch) ==="
          echo "CREATE TABLE test_table (id INTEGER, name VARCHAR, value DOUBLE);" | isql -v -k "$CONN" 2>&1

          echo "=== Test 4: DML - INSERT rows (lazy fetch) ==="
          echo "INSERT INTO test_table VALUES (1, 'alice', 3.14);" | isql -v -k "$CONN" 2>&1
          echo "INSERT INTO test_table VALUES (2, 'bob', 2.72);" | isql -v -k "$CONN" 2>&1
          echo "INSERT INTO test_table VALUES (3, 'charlie', 1.41);" | isql -v -k "$CONN" 2>&1

          echo "=== Test 5: SELECT inserted data ==="
          echo "SELECT id, name, value FROM test_table ORDER BY id;" | isql -v -k "$CONN" 2>&1

          echo "=== Test 6: DML - UPDATE (lazy fetch) ==="
          echo "UPDATE test_table SET value = 9.99 WHERE id = 2;" | isql -v -k "$CONN" 2>&1

          echo "=== Test 7: SELECT after UPDATE ==="
          echo "SELECT id, name, value FROM test_table WHERE id = 2;" | isql -v -k "$CONN" 2>&1

          echo "=== Test 8: DML - DELETE (lazy fetch) ==="
          echo "DELETE FROM test_table WHERE id = 3;" | isql -v -k "$CONN" 2>&1

          echo "=== Test 9: SELECT after DELETE ==="
          echo "SELECT COUNT(*) AS row_count FROM test_table;" | isql -v -k "$CONN" 2>&1

          echo "=== Test 10: DDL - DROP TABLE (lazy fetch) ==="
          echo "DROP TABLE test_table;" | isql -v -k "$CONN" 2>&1

          echo "=== All integration tests completed ==="

  sign-windows:
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        arch: [x64, arm64]
    runs-on: windows-latest
    name: Sign Windows (${{ matrix.arch }})
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: gizmosql-odbc-windows-${{ matrix.arch }}.dll
          path: unsigned

      - name: Azure login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install AzureSignTool
        run: dotnet tool install --global AzureSignTool

      - name: Sign DLLs
        run: |
          Get-ChildItem -Path unsigned -Filter *.dll -Recurse | ForEach-Object {
            AzureSignTool sign `
              --azure-key-vault-url "${{ secrets.AZURE_KEY_VAULT_URI }}" `
              --azure-key-vault-certificate "${{ secrets.AZURE_CERT_NAME }}" `
              --azure-key-vault-managed-identity `
              --timestamp-rfc3161 http://timestamp.digicert.com `
              --timestamp-digest sha256 `
              --file-digest sha256 `
              --verbose `
              $_.FullName
          }

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: gizmosql-odbc-windows-${{ matrix.arch }}-signed.dll
          path: unsigned/**/*.dll
          if-no-files-found: error

  build-msi:
    needs: sign-windows
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        arch: [x64, arm64]
    runs-on: windows-latest
    name: Build MSI (${{ matrix.arch }})
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download signed DLL
        uses: actions/download-artifact@v4
        with:
          name: gizmosql-odbc-windows-${{ matrix.arch }}-signed.dll
          path: installer/bin

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Convert logo to BMP for installer dialogs
        run: |
          Add-Type -AssemblyName System.Drawing
          # Create banner (493x58)
          $banner = New-Object System.Drawing.Bitmap(493, 58)
          $g = [System.Drawing.Graphics]::FromImage($banner)
          $g.Clear([System.Drawing.Color]::White)
          $logo = [System.Drawing.Image]::FromFile("${{ github.workspace }}\installer\gizmosql_logo.png")
          $g.DrawImage($logo, 10, 4, 200, 50)
          $g.Dispose()
          $banner.Save("${{ github.workspace }}\installer\banner.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          # Create dialog (493x312)
          $dialog = New-Object System.Drawing.Bitmap(493, 312)
          $g = [System.Drawing.Graphics]::FromImage($dialog)
          $g.Clear([System.Drawing.Color]::White)
          $g.DrawImage($logo, 20, 20, 300, 75)
          $g.Dispose()
          $dialog.Save("${{ github.workspace }}\installer\dialog.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          $logo.Dispose()

      - name: Create license.rtf
        run: |
          $license = Get-Content "${{ github.workspace }}\LICENSE" -Raw
          $rtf = "{\rtf1\ansi\deff0 {\fonttbl {\f0 Consolas;}}\f0\fs18 " + ($license -replace "`n", "\par ") + "}"
          Set-Content -Path "${{ github.workspace }}\installer\license.rtf" -Value $rtf

      - name: Build MSI
        run: |
          wix build `
            "${{ github.workspace }}\installer\GizmoSqlOdbc.wxs" `
            -bindpath:BinDir="${{ github.workspace }}\installer\bin" `
            -o "${{ github.workspace }}\installer\GizmoSQL-ODBC-Driver-${{ matrix.arch }}.msi" `
            -ext WixToolset.UI.wixext

      - name: Azure login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install AzureSignTool
        run: dotnet tool install --global AzureSignTool

      - name: Sign MSI
        run: |
          AzureSignTool sign `
            --azure-key-vault-url "${{ secrets.AZURE_KEY_VAULT_URI }}" `
            --azure-key-vault-certificate "${{ secrets.AZURE_CERT_NAME }}" `
            --azure-key-vault-managed-identity `
            --timestamp-rfc3161 http://timestamp.digicert.com `
            --timestamp-digest sha256 `
            --file-digest sha256 `
            --verbose `
            "${{ github.workspace }}\installer\GizmoSQL-ODBC-Driver-${{ matrix.arch }}.msi"

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: GizmoSQL-ODBC-Driver-${{ matrix.arch }}.msi
          path: installer/GizmoSQL-ODBC-Driver-${{ matrix.arch }}.msi
          if-no-files-found: error

  release:
    needs: [build-linux, build-macos, build-windows, sign-windows, build-msi, integration-test-linux]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    name: Release
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release assets
        run: |
          mkdir -p release
          # Linux artifacts
          find artifacts -name "libgizmosql*linux*x64*" -exec cp {} release/libgizmosql-odbc-linux-x64.so \;
          find artifacts -name "libgizmosql*linux*arm64*" -exec cp {} release/libgizmosql-odbc-linux-arm64.so \;
          # macOS artifact
          find artifacts -name "libgizmosql*macos*" -exec cp {} release/libgizmosql-odbc-macos-arm64.dylib \;
          # Windows signed artifacts (prefer signed over unsigned)
          find artifacts -name "*windows*x64*signed*/*.dll" -exec cp {} release/gizmosql-odbc-windows-x64.dll \; 2>/dev/null || \
            find artifacts -name "*windows*x64*/*.dll" -exec cp {} release/gizmosql-odbc-windows-x64.dll \;
          find artifacts -name "*windows*arm64*signed*/*.dll" -exec cp {} release/gizmosql-odbc-windows-arm64.dll \; 2>/dev/null || \
            find artifacts -name "*windows*arm64*/*.dll" -exec cp {} release/gizmosql-odbc-windows-arm64.dll \;
          # MSI installers
          find artifacts -name "GizmoSQL-ODBC-Driver-x64.msi" -exec cp {} release/ \; 2>/dev/null
          find artifacts -name "GizmoSQL-ODBC-Driver-arm64.msi" -exec cp {} release/ \; 2>/dev/null

      - name: Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: release/*

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            release/*

  update-homebrew:
    needs: release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    name: Update Homebrew Tap
    steps:
      - name: Generate formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="${TAG#v}"
          BASE_URL="https://github.com/gizmodata/gizmosql-odbc-driver/releases/download/${TAG}"

          # Download artifacts and compute sha256 hashes
          curl -sL -o macos-arm64.dylib "${BASE_URL}/libgizmosql-odbc-macos-arm64.dylib"
          MACOS_ARM64_SHA256=$(sha256sum macos-arm64.dylib | awk '{print $1}')

          curl -sL -o linux-x64.so "${BASE_URL}/libgizmosql-odbc-linux-x64.so"
          LINUX_X64_SHA256=$(sha256sum linux-x64.so | awk '{print $1}')

          curl -sL -o linux-arm64.so "${BASE_URL}/libgizmosql-odbc-linux-arm64.so"
          LINUX_ARM64_SHA256=$(sha256sum linux-arm64.so | awk '{print $1}')

          cat > gizmosql-odbc.rb << FORMULA_EOF
          # typed: false
          # frozen_string_literal: true

          class GizmosqlOdbc < Formula
            desc "GizmoSQL ODBC Driver"
            homepage "https://gizmodata.com/gizmosql"
            version "${VERSION}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/libgizmosql-odbc-macos-arm64.dylib"
                sha256 "${MACOS_ARM64_SHA256}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${BASE_URL}/libgizmosql-odbc-linux-arm64.so"
                sha256 "${LINUX_ARM64_SHA256}"
              elsif Hardware::CPU.intel?
                url "${BASE_URL}/libgizmosql-odbc-linux-x64.so"
                sha256 "${LINUX_X64_SHA256}"
              end
            end

            def install
              if OS.mac?
                lib.install "libgizmosql-odbc-macos-arm64.dylib" => "libgizmosql-odbc.dylib"
              elsif OS.linux?
                if Hardware::CPU.arm?
                  lib.install "libgizmosql-odbc-linux-arm64.so" => "libgizmosql-odbc.so"
                else
                  lib.install "libgizmosql-odbc-linux-x64.so" => "libgizmosql-odbc.so"
                end
              end
            end

            def caveats
              if OS.mac?
                <<~EOS
                  To register the driver, add the following to /usr/local/etc/odbcinst.ini:

                    [GizmoSQL ODBC Driver]
                    Driver = #{lib}/libgizmosql-odbc.dylib

                  Then add a DSN to ~/.odbc.ini:

                    [GizmoSQL]
                    Driver        = GizmoSQL ODBC Driver
                    host          = localhost
                    port          = 32010
                    uid           = your-username
                    pwd           = your-password
                    useEncryption = true
                EOS
              else
                <<~EOS
                  To register the driver, add the following to /etc/odbcinst.ini:

                    [GizmoSQL ODBC Driver]
                    Driver = #{lib}/libgizmosql-odbc.so

                  Then add a DSN to ~/.odbc.ini:

                    [GizmoSQL]
                    Driver        = GizmoSQL ODBC Driver
                    host          = localhost
                    port          = 32010
                    uid           = your-username
                    pwd           = your-password
                    useEncryption = true
                EOS
              end
            end

            test do
              if OS.mac?
                assert_predicate lib/"libgizmosql-odbc.dylib", :exist?
              else
                assert_predicate lib/"libgizmosql-odbc.so", :exist?
              end
            end
          end
          FORMULA_EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' gizmosql-odbc.rb

      - name: Update tap repository
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/gizmodata/homebrew-tap.git"
          cp gizmosql-odbc.rb homebrew-tap/Formula/gizmosql-odbc.rb
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gizmosql-odbc.rb
          git commit -m "Update gizmosql-odbc to ${TAG}"
          git push
