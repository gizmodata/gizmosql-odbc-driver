name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    name: Build Linux (${{ matrix.arch }})
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libboost-all-dev \
            unixodbc-dev \
            libgrpc++-dev \
            libprotobuf-dev \
            libprotoc-dev \
            protobuf-compiler \
            protobuf-compiler-grpc \
            libssl-dev \
            rapidjson-dev

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: libgizmosql-odbc-linux-${{ matrix.arch }}.so
          path: build/*/lib/libgizmosql-odbc.so
          if-no-files-found: error

  build-macos:
    runs-on: macos-latest
    name: Build macOS (arm64)
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake boost libiodbc grpc protobuf openssl@3 rapidjson

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: libgizmosql-odbc-macos-arm64.dylib
          path: build/*/lib/libgizmosql-odbc.dylib
          if-no-files-found: error

  build-windows:
    # NOTE: ARM64 Windows disabled â€” Arrow 23 cross-compilation includes SSE
    # headers (xmmintrin.h/emmintrin.h) even with ARROW_SIMD_LEVEL=NONE.
    # x64 binary works on ARM64 Windows via emulation.
    runs-on: windows-2022
    name: Build Windows (x64)
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        shell: pwsh
        run: |
          # Remove large preinstalled tools not needed for C++ builds
          @(
            "C:\Program Files\Android",
            "C:\Program Files\Eclipse Adoptium",
            "C:\ghcup",
            "$env:AGENT_TOOLSDIRECTORY"
          ) | ForEach-Object {
            if (Test-Path $_) {
              Write-Host "Removing $_"
              Remove-Item -Recurse -Force $_ -ErrorAction SilentlyContinue
            }
          }
          Get-PSDrive C | Select-Object Name, @{N='Free(GB)';E={[math]::Round($_.Free/1GB,1)}}

      - name: Set up vcpkg
        run: |
          echo "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT" >> $env:GITHUB_ENV

      - name: Export GitHub Actions cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install dependencies
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
        run: |
          & "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe" install --triplet x64-windows-static-md --clean-after-build --x-install-root="$env:VCPKG_INSTALLATION_ROOT\installed"

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure
        run: |
          cmake -B build `
            -DARROW_GIT_REPOSITORY=https://github.com/apache/arrow.git `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static-md `
            -DVCPKG_MANIFEST_MODE=OFF `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_C_COMPILER_LAUNCHER=sccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: cmake --build build --parallel 8 --config Release

      - name: Upload shared library
        uses: actions/upload-artifact@v4
        with:
          name: gizmosql-odbc-windows-x64.dll
          path: build/Release/**/gizmosql-odbc.dll
          if-no-files-found: error

  integration-test-linux:
    needs: build-linux
    name: Integration Tests (Linux x64)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    services:
      gizmosql:
        image: gizmodata/gizmosql:latest
        ports:
          - 31337:31337
        env:
          GIZMOSQL_USERNAME: gizmosql_user
          GIZMOSQL_PASSWORD: gizmosql_password
          DATABASE_FILENAME: /tmp/test.duckdb
          TLS_ENABLED: "0"
          PRINT_QUERIES: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Install ODBC runtime and driver dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc libgrpc++-dev libprotobuf-dev libssl-dev

      - name: Download driver artifact
        uses: actions/download-artifact@v4
        with:
          name: libgizmosql-odbc-linux-x64.so
          path: driver

      - name: Find and install driver
        run: |
          DRIVER_PATH=$(find driver -name '*.so' -print -quit)
          cp "$DRIVER_PATH" /tmp/libgizmosql-odbc.so
          chmod +x /tmp/libgizmosql-odbc.so
          echo "DRIVER_PATH=/tmp/libgizmosql-odbc.so" >> $GITHUB_ENV

      - name: Verify exported symbols
        run: |
          echo "=== Exported SQL symbols ==="
          nm -D "$DRIVER_PATH" | grep ' T SQL' | head -20
          echo "..."
          nm -D "$DRIVER_PATH" | grep -c ' T SQL'
          echo "SQL* symbols exported"

      - name: Wait for GizmoSQL
        run: |
          for i in $(seq 1 30); do
            nc -z localhost 31337 && echo "GizmoSQL is ready" && exit 0
            echo "Waiting for GizmoSQL... ($i/30)"
            sleep 2
          done
          echo "GizmoSQL did not start in time" && exit 1

      - name: Register driver and DSN
        run: |
          # Write driver registration to system location
          sudo tee /etc/odbcinst.ini > /dev/null << 'EOF'
          [GizmoSQL ODBC Driver]
          Description = GizmoSQL ODBC Driver
          Driver      = /tmp/libgizmosql-odbc.so
          EOF

          # Write DSN to user location
          cat > ~/.odbc.ini << 'EOF'
          [GizmoSQL Test]
          Driver        = GizmoSQL ODBC Driver
          host          = localhost
          port          = 31337
          uid           = gizmosql_user
          pwd           = gizmosql_password
          useEncryption = false
          EOF

      - name: Run integration tests with isql
        run: |
          CONN="Driver=/tmp/libgizmosql-odbc.so;host=localhost;port=31337;uid=gizmosql_user;pwd=gizmosql_password;useEncryption=false"

          echo "=== Test 1: Basic SELECT via connection string ==="
          echo "SELECT 42 AS answer;" | isql -v -k "$CONN"

          echo "=== Test 2: Basic SELECT via DSN ==="
          echo "SELECT 1 AS test_value;" | isql -v "GizmoSQL Test"

          echo "=== Test 3: DDL/DML round-trip (single session) ==="
          isql -v -k "$CONN" << 'SQL'
          CREATE TABLE test_table (id INTEGER, name VARCHAR, value DOUBLE)
          INSERT INTO test_table VALUES (1, 'alice', 3.14)
          INSERT INTO test_table VALUES (2, 'bob', 2.72)
          INSERT INTO test_table VALUES (3, 'charlie', 1.41)
          SELECT id, name, value FROM test_table ORDER BY id
          UPDATE test_table SET value = 9.99 WHERE id = 2
          SELECT id, name, value FROM test_table WHERE id = 2
          DELETE FROM test_table WHERE id = 3
          SELECT COUNT(*) AS row_count FROM test_table
          DROP TABLE test_table
          SQL

          echo "=== Test 4: DDL/DML across connections ==="
          echo "CREATE TABLE cross_conn_test (id INTEGER, val VARCHAR);" | isql -v -k "$CONN"
          echo "INSERT INTO cross_conn_test VALUES (1, 'hello');" | isql -v -k "$CONN"
          echo "SELECT id, val FROM cross_conn_test;" | isql -v -k "$CONN"
          echo "DROP TABLE cross_conn_test;" | isql -v -k "$CONN"

          echo "=== All integration tests completed ==="

  sign-windows:
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    name: Sign Windows (x64)
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: gizmosql-odbc-windows-x64.dll
          path: unsigned

      - name: Azure login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install AzureSignTool
        run: dotnet tool install --global AzureSignTool

      - name: Sign DLLs
        run: |
          Get-ChildItem -Path unsigned -Filter *.dll -Recurse | ForEach-Object {
            AzureSignTool sign `
              --azure-key-vault-url "${{ secrets.AZURE_KEY_VAULT_URI }}" `
              --azure-key-vault-certificate "${{ secrets.AZURE_CERT_NAME }}" `
              --azure-key-vault-managed-identity `
              --timestamp-rfc3161 http://timestamp.digicert.com `
              --timestamp-digest sha256 `
              --file-digest sha256 `
              --verbose `
              $_.FullName
          }

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: gizmosql-odbc-windows-x64-signed.dll
          path: unsigned/**/*.dll
          if-no-files-found: error

  build-msi:
    needs: sign-windows
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    name: Build MSI (x64)
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download signed DLL
        uses: actions/download-artifact@v4
        with:
          name: gizmosql-odbc-windows-x64-signed.dll
          path: installer/bin

      - name: Install WiX Toolset
        run: dotnet tool install --global wix

      - name: Convert logo to BMP for installer dialogs
        run: |
          Add-Type -AssemblyName System.Drawing
          # Create banner (493x58)
          $banner = New-Object System.Drawing.Bitmap(493, 58)
          $g = [System.Drawing.Graphics]::FromImage($banner)
          $g.Clear([System.Drawing.Color]::White)
          $logo = [System.Drawing.Image]::FromFile("${{ github.workspace }}\installer\gizmosql_logo.png")
          $g.DrawImage($logo, 10, 4, 200, 50)
          $g.Dispose()
          $banner.Save("${{ github.workspace }}\installer\banner.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          # Create dialog (493x312)
          $dialog = New-Object System.Drawing.Bitmap(493, 312)
          $g = [System.Drawing.Graphics]::FromImage($dialog)
          $g.Clear([System.Drawing.Color]::White)
          $g.DrawImage($logo, 20, 20, 300, 75)
          $g.Dispose()
          $dialog.Save("${{ github.workspace }}\installer\dialog.bmp", [System.Drawing.Imaging.ImageFormat]::Bmp)
          $logo.Dispose()

      - name: Create license.rtf
        run: |
          $license = Get-Content "${{ github.workspace }}\LICENSE" -Raw
          $rtf = "{\rtf1\ansi\deff0 {\fonttbl {\f0 Consolas;}}\f0\fs18 " + ($license -replace "`n", "\par ") + "}"
          Set-Content -Path "${{ github.workspace }}\installer\license.rtf" -Value $rtf

      - name: Build MSI
        run: |
          wix build `
            "${{ github.workspace }}\installer\GizmoSqlOdbc.wxs" `
            -bindpath:BinDir="${{ github.workspace }}\installer\bin" `
            -o "${{ github.workspace }}\installer\GizmoSQL-ODBC-Driver-x64.msi" `
            -ext WixToolset.UI.wixext

      - name: Azure login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install AzureSignTool
        run: dotnet tool install --global AzureSignTool

      - name: Sign MSI
        run: |
          AzureSignTool sign `
            --azure-key-vault-url "${{ secrets.AZURE_KEY_VAULT_URI }}" `
            --azure-key-vault-certificate "${{ secrets.AZURE_CERT_NAME }}" `
            --azure-key-vault-managed-identity `
            --timestamp-rfc3161 http://timestamp.digicert.com `
            --timestamp-digest sha256 `
            --file-digest sha256 `
            --verbose `
            "${{ github.workspace }}\installer\GizmoSQL-ODBC-Driver-x64.msi"

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: GizmoSQL-ODBC-Driver-x64.msi
          path: installer/GizmoSQL-ODBC-Driver-x64.msi
          if-no-files-found: error

  release:
    needs: [build-linux, build-macos, build-windows, sign-windows, build-msi, integration-test-linux]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    name: Release
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release assets
        run: |
          mkdir -p release
          # Linux artifacts
          find artifacts -name "libgizmosql*linux*x64*" -exec cp {} release/libgizmosql-odbc-linux-x64.so \;
          find artifacts -name "libgizmosql*linux*arm64*" -exec cp {} release/libgizmosql-odbc-linux-arm64.so \;
          # macOS artifact
          find artifacts -name "libgizmosql*macos*" -exec cp {} release/libgizmosql-odbc-macos-arm64.dylib \;
          # Windows signed artifacts (prefer signed over unsigned)
          find artifacts -name "*windows*x64*signed*/*.dll" -exec cp {} release/gizmosql-odbc-windows-x64.dll \; 2>/dev/null || \
            find artifacts -name "*windows*x64*/*.dll" -exec cp {} release/gizmosql-odbc-windows-x64.dll \;
          # MSI installer
          find artifacts -name "GizmoSQL-ODBC-Driver-x64.msi" -exec cp {} release/ \; 2>/dev/null

      - name: Generate build provenance attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: release/*

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            release/*

  update-homebrew:
    needs: release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    name: Update Homebrew Tap
    steps:
      - name: Generate formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="${TAG#v}"
          BASE_URL="https://github.com/gizmodata/gizmosql-odbc-driver/releases/download/${TAG}"

          # Download artifacts and compute sha256 hashes
          curl -sL -o macos-arm64.dylib "${BASE_URL}/libgizmosql-odbc-macos-arm64.dylib"
          MACOS_ARM64_SHA256=$(sha256sum macos-arm64.dylib | awk '{print $1}')

          curl -sL -o linux-x64.so "${BASE_URL}/libgizmosql-odbc-linux-x64.so"
          LINUX_X64_SHA256=$(sha256sum linux-x64.so | awk '{print $1}')

          curl -sL -o linux-arm64.so "${BASE_URL}/libgizmosql-odbc-linux-arm64.so"
          LINUX_ARM64_SHA256=$(sha256sum linux-arm64.so | awk '{print $1}')

          cat > gizmosql-odbc.rb << FORMULA_EOF
          # typed: false
          # frozen_string_literal: true

          class GizmosqlOdbc < Formula
            desc "GizmoSQL ODBC Driver"
            homepage "https://gizmodata.com/gizmosql"
            version "${VERSION}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/libgizmosql-odbc-macos-arm64.dylib"
                sha256 "${MACOS_ARM64_SHA256}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${BASE_URL}/libgizmosql-odbc-linux-arm64.so"
                sha256 "${LINUX_ARM64_SHA256}"
              elsif Hardware::CPU.intel?
                url "${BASE_URL}/libgizmosql-odbc-linux-x64.so"
                sha256 "${LINUX_X64_SHA256}"
              end
            end

            def install
              if OS.mac?
                lib.install "libgizmosql-odbc-macos-arm64.dylib" => "libgizmosql-odbc.dylib"
              elsif OS.linux?
                if Hardware::CPU.arm?
                  lib.install "libgizmosql-odbc-linux-arm64.so" => "libgizmosql-odbc.so"
                else
                  lib.install "libgizmosql-odbc-linux-x64.so" => "libgizmosql-odbc.so"
                end
              end
            end

            def caveats
              if OS.mac?
                <<~EOS
                  To register the driver, add the following to /usr/local/etc/odbcinst.ini:

                    [GizmoSQL ODBC Driver]
                    Driver = #{lib}/libgizmosql-odbc.dylib

                  Then add a DSN to ~/.odbc.ini:

                    [GizmoSQL]
                    Driver        = GizmoSQL ODBC Driver
                    host          = localhost
                    port          = 32010
                    uid           = your-username
                    pwd           = your-password
                    useEncryption = true
                EOS
              else
                <<~EOS
                  To register the driver, add the following to /etc/odbcinst.ini:

                    [GizmoSQL ODBC Driver]
                    Driver = #{lib}/libgizmosql-odbc.so

                  Then add a DSN to ~/.odbc.ini:

                    [GizmoSQL]
                    Driver        = GizmoSQL ODBC Driver
                    host          = localhost
                    port          = 32010
                    uid           = your-username
                    pwd           = your-password
                    useEncryption = true
                EOS
              end
            end

            test do
              if OS.mac?
                assert_predicate lib/"libgizmosql-odbc.dylib", :exist?
              else
                assert_predicate lib/"libgizmosql-odbc.so", :exist?
              end
            end
          end
          FORMULA_EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' gizmosql-odbc.rb

      - name: Update tap repository
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          git clone "https://x-access-token:${GH_TOKEN}@github.com/gizmodata/homebrew-tap.git"
          cp gizmosql-odbc.rb homebrew-tap/Formula/gizmosql-odbc.rb
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gizmosql-odbc.rb
          git commit -m "Update gizmosql-odbc to ${TAG}"
          git push
